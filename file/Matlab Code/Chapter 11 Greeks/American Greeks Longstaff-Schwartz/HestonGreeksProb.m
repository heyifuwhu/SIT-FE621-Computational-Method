function y = HestonGreeksProb(phi,kappa,theta,lambda,rho,sigma,tau,K,S,r,q,v,Pnum,Trap,Greek);

% Returns the integrands for the Heston Greeks
% INPUTS -------------------------------------------------------
%   phi = integration variable
%   Pnum = 1 or 2 (for the probabilities)
%   Heston parameters:
%     kappa  = volatility mean reversion speed parameter
%     theta  = volatility mean reversion level parameter
%     lambda = risk parameter
%     rho    = correlation between two Brownian motions
%     sigma  = volatility of variance
%     v      = initial variance
%   Option features.
%     PutCall = 'C'all or 'P'ut
%     K = strike price
%     S = spot price
%     r = risk free rate
%     Trap = 1 "Little Trap" formulation 
%            0  Original Heston formulation
%   Greek = 'Delta', 'Rho', 'Gamma', 'Theta', 'Vega1'
%           'Vega2', 'Vanna', 'Volga', 'Kappa','Sigma','Corr'
% OUTPUT -------------------------------------------------------
%   The integrand for the chosen Greek

% Log of the stock price.
x = log(S);

% Parameter "a" is the same for P1 and P2.
a = kappa*theta;

% Parameters "u" and "b" are different for P1 and P2.
if Pnum==1
	u = 0.5;
	b = kappa + lambda - rho*sigma;
else
	u = -0.5;
	b = kappa + lambda;
end

d = sqrt((rho*sigma*i*phi - b)^2 - sigma^2*(2*u*i*phi - phi^2));
g = (b - rho*sigma*i*phi + d) / (b - rho*sigma*i*phi - d);

if Trap==1
	% "Little Heston Trap" formulation
	c = 1/g;
	D = (b - rho*sigma*i*phi - d)/sigma^2*((1-exp(-d*tau))/(1-c*exp(-d*tau)));
	G = (1 - c*exp(-d*tau))/(1-c);
	C = (r-q)*i*phi*tau + a/sigma^2*((b - rho*sigma*i*phi - d)*tau - 2*log(G));
elseif Trap==0
	% Original Heston formulation.
	G = (1 - g*exp(d*tau))/(1-g);
	C = (r-q)*i*phi*tau + a/sigma^2*((b - rho*sigma*i*phi + d)*tau - 2*log(G));
	D = (b - rho*sigma*i*phi + d)/sigma^2*((1-exp(d*tau))/(1-g*exp(d*tau)));
end

% The characteristic function.
f = exp(C + D*v + i*phi*x);

% Return the real part of the integrand.
if strcmp(Greek,'Delta') | strcmp(Greek,'Rho')
	% Pj
	y = real(exp(-i*phi*log(K))*f/i/phi);
elseif strcmp(Greek,'Gamma')
	% der(P1^2)/der(S^2)
	y = real(exp(-i*phi*log(K))*f);
elseif strcmp(Greek,'Theta')
	% dP/dtau
	dD = d*exp(d*tau)*(b-rho*sigma*phi*i+d)*(g-1)/sigma^2/(1-g*exp(d*tau))^2;
	dC = (r-q)*phi*i + kappa*theta/sigma^2 ...
		* ((b-rho*sigma*phi*i+d) + 2*g*d*exp(d*tau)/(1-g*exp(d*tau)));
	df = f*(dC + dD*v);
	y = real(exp(-i*phi*log(K))*df/i/phi);
elseif strcmp(Greek,'Vega1')
	% dP/dv0
	y = real(exp(-i*phi*log(K))*f*D/i/phi);
elseif strcmp(Greek,'Vega2')
	if Trap==1
		dC = (r-q)*i*phi*tau + kappa/sigma^2*((b - rho*sigma*i*phi - d)*tau - 2*log(G));
	elseif Trap==0
		dC = (r-q)*i*phi*tau + kappa/sigma^2*((b - rho*sigma*i*phi + d)*tau - 2*log(G));
	end
	df =f*dC;
	y = real(exp(-i*phi*log(K))*df/i/phi);
elseif strcmp(Greek,'Volga')
	% dP2/dv02
	y = real(exp(-i*phi*log(K))*f*D^2/i/phi);
elseif strcmp(Greek,'Corr')
	if Pnum==1
		dCdr = kappa*theta/sigma^2*((-sigma-sigma*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa+4*rho*sigma^2*i*phi-2*kappa*sigma+2*rho*sigma^2))*tau-2*((-(-sigma-sigma*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa+4*rho*sigma^2*i*phi-2*kappa*sigma+2*rho*sigma^2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)+(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)*(-sigma-sigma*i*phi-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa+4*rho*sigma^2*i*phi-2*kappa*sigma+2*rho*sigma^2))-1/2*(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa+4*rho*sigma^2*i*phi-2*kappa*sigma+2*rho*sigma^2)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)))-(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)))^2*(-(-sigma-sigma*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa+4*rho*sigma^2*i*phi-2*kappa*sigma+2*rho*sigma^2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))+(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*(-sigma-sigma*i*phi-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa+4*rho*sigma^2*i*phi-2*kappa*sigma+2*rho*sigma^2))))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))*(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))));
		dDdr = (-sigma-sigma*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa+4*rho*sigma^2*i*phi-2*kappa*sigma+2*rho*sigma^2))/sigma^2*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-1/2*(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa+4*rho*sigma^2*i*phi-2*kappa*sigma+2*rho*sigma^2)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^2*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))^2*(-(-sigma-sigma*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa+4*rho*sigma^2*i*phi-2*kappa*sigma+2*rho*sigma^2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)+(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)*(-sigma-sigma*i*phi-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa+4*rho*sigma^2*i*phi-2*kappa*sigma+2*rho*sigma^2))-1/2*(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa+4*rho*sigma^2*i*phi-2*kappa*sigma+2*rho*sigma^2)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau));
  	elseif Pnum==2
		dCdr = kappa*theta/sigma^2*((-sigma*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa))*tau-2*((-(-sigma*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)+(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)*(-sigma*i*phi-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa))-1/2*(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)))-(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)))^2*(-(-sigma*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))+(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*(-sigma*i*phi-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa))))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))*(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))));
		dDdr = (-sigma*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa))/sigma^2*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-1/2*(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^2*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))^2*(-(-sigma*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)+(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)*(-sigma*i*phi-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa))-1/2*(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(2*rho*sigma^2*i^2*phi^2-2*sigma*i*phi*kappa)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau));
	end
	y = real(exp(-i*phi*log(K))*f*(dCdr + dDdr*v)/i/phi);
elseif strcmp(Greek,'Sigma')
	if Pnum==1
		dCds = -2*kappa*theta/sigma^3*((kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*tau-2*log((1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)))))+kappa*theta/sigma^2*((-rho-rho*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+4*rho^2*sigma*i*phi-2*kappa*rho+2*rho^2*sigma-2*sigma*i*phi+2*sigma*phi^2))*tau-2*((-(-rho-rho*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+4*rho^2*sigma*i*phi-2*kappa*rho+2*rho^2*sigma-2*sigma*i*phi+2*sigma*phi^2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)+(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)*(-rho-rho*i*phi-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+4*rho^2*sigma*i*phi-2*kappa*rho+2*rho^2*sigma-2*sigma*i*phi+2*sigma*phi^2))-1/2*(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+4*rho^2*sigma*i*phi-2*kappa*rho+2*rho^2*sigma-2*sigma*i*phi+2*sigma*phi^2)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)))-(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)))^2*(-(-rho-rho*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+4*rho^2*sigma*i*phi-2*kappa*rho+2*rho^2*sigma-2*sigma*i*phi+2*sigma*phi^2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))+(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*(-rho-rho*i*phi-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+4*rho^2*sigma*i*phi-2*kappa*rho+2*rho^2*sigma-2*sigma*i*phi+2*sigma*phi^2))))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))*(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))));
		dDds = (-rho-rho*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+4*rho^2*sigma*i*phi-2*kappa*rho+2*rho^2*sigma-2*sigma*i*phi+2*sigma*phi^2))/sigma^2*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-2*(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^3*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-1/2*(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+4*rho^2*sigma*i*phi-2*kappa*rho+2*rho^2*sigma-2*sigma*i*phi+2*sigma*phi^2)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^2*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))^2*(-(-rho-rho*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+4*rho^2*sigma*i*phi-2*kappa*rho+2*rho^2*sigma-2*sigma*i*phi+2*sigma*phi^2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)+(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)*(-rho-rho*i*phi-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+4*rho^2*sigma*i*phi-2*kappa*rho+2*rho^2*sigma-2*sigma*i*phi+2*sigma*phi^2))-1/2*(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+4*rho^2*sigma*i*phi-2*kappa*rho+2*rho^2*sigma-2*sigma*i*phi+2*sigma*phi^2)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau));
  	elseif Pnum==2
		dCds = -2*kappa*theta/sigma^3*((kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*tau-2*log((1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)))))+kappa*theta/sigma^2*((-rho*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+2*sigma*i*phi+2*sigma*phi^2))*tau-2*((-(-rho*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+2*sigma*i*phi+2*sigma*phi^2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)+(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)*(-rho*i*phi-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+2*sigma*i*phi+2*sigma*phi^2))-1/2*(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+2*sigma*i*phi+2*sigma*phi^2)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)))-(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)))^2*(-(-rho*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+2*sigma*i*phi+2*sigma*phi^2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))+(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*(-rho*i*phi-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+2*sigma*i*phi+2*sigma*phi^2))))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))*(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))));
		dDds = (-rho*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+2*sigma*i*phi+2*sigma*phi^2))/sigma^2*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-2*(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^3*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-1/2*(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+2*sigma*i*phi+2*sigma*phi^2)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^2*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))^2*(-(-rho*i*phi+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+2*sigma*i*phi+2*sigma*phi^2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)+(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)*(-rho*i*phi-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+2*sigma*i*phi+2*sigma*phi^2))-1/2*(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(2*rho^2*sigma*i^2*phi^2-2*rho*i*phi*kappa+2*sigma*i*phi+2*sigma*phi^2)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau));
	end
	y = real(exp(-i*phi*log(K))*f*(dCds + dDds*v)/i/phi);
elseif strcmp(Greek,'Kappa')
	if Pnum==1
		dCdk = theta/sigma^2*((kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*tau-2*log((1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)))))+kappa*theta/sigma^2*((1+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa-2*rho*sigma))*tau-2*((-(1+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa-2*rho*sigma))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)+(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)*(1-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa-2*rho*sigma))-1/2*(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(-2*rho*sigma*i*phi+2*kappa-2*rho*sigma)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)))-(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)))^2*(-(1+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa-2*rho*sigma))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))+(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*(1-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa-2*rho*sigma))))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))*(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))));
		dDdk = (1+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa-2*rho*sigma))/sigma^2*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-1/2*(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(-2*rho*sigma*i*phi+2*kappa-2*rho*sigma)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^2*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))^2*(-(1+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa-2*rho*sigma))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)+(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)*(1-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa-2*rho*sigma))-1/2*(kappa-rho*sigma-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(-2*rho*sigma*i*phi+2*kappa-2*rho*sigma)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+2*rho^2*sigma^2*i*phi+kappa^2-2*kappa*rho*sigma+rho^2*sigma^2-sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau));
  	elseif Pnum==2
		dCdk = theta/sigma^2*((kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*tau-2*log((1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)))))+kappa*theta/sigma^2*((1+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa))*tau-2*((-(1+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)+(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)*(1-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa))-1/2*(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(-2*rho*sigma*i*phi+2*kappa)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)))-(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)))^2*(-(1+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))+(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*(1-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa))))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))*(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))));
		dDdk = (1+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa))/sigma^2*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-1/2*(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(-2*rho*sigma*i*phi+2*kappa)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/sigma^2*(1-exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))/(1-(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau))^2*(-(1+1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)+(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))^2*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau)*(1-1/2/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*(-2*rho*sigma*i*phi+2*kappa))-1/2*(kappa-rho*sigma*i*phi+(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(kappa-rho*sigma*i*phi-(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2))/(rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau*(-2*rho*sigma*i*phi+2*kappa)*exp((rho^2*sigma^2*i^2*phi^2-2*rho*sigma*i*phi*kappa+kappa^2+sigma^2*i*phi+sigma^2*phi^2)^(1/2)*tau));
	end
	y = real(exp(-i*phi*log(K))*f*(dCdk + dDdk*v)/i/phi);
end

